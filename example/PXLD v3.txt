# **PXLD v3 å”è­°è¦ç¯„æ–‡ä»¶**

## **1. è¨­è¨ˆç›®æ¨™**

- âœ… **è‡ªæè¿°å„ªå…ˆ**: æ‰€æœ‰çµæ§‹å°ºå¯¸ã€æ•¸é‡åœ¨ header ä¸­æ˜ç¢ºå®£å‘Š,è§£ç¢¼å™¨é›¶ç¡¬ç·¨ç¢¼
- âœ… **æ¥µç°¡é©—è­‰**: æœ¬åœ°æª”æ¡ˆåƒ…åœ¨ FileHeader åšä¸€æ¬¡ CRC32 é©—è­‰
- âœ… **é«˜æ•ˆè§£æ**: æ”¯æ´éš¨æ©Ÿè·³è½‰åˆ°ä»»æ„ frame (åŸºæ–¼è‡ªæè¿° offset è¨ˆç®—)
- âœ… **å‘å¾Œå…¼å®¹**: ä¿ç•™ PXLD magicã€UDP 4050 åŸ ç­‰æ ¸å¿ƒç‰¹æ€§

---

## **2. æª”æ¡ˆçµæ§‹ç¸½è¦½**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FileHeader (64 bytes)                   â”‚ â† ä¸€æ¬¡æ€§é©—è­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frame 0                                 â”‚
â”‚  â”œâ”€ FrameHeader (32 bytes)              â”‚
â”‚  â”œâ”€ SlaveTable (slave_count Ã— 24 bytes) â”‚
â”‚  â””â”€ PixelData (è®Šé•·)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frame 1 ...                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frame N                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## **3. FileHeader (64 bytes) - æª”æ¡ˆç´šå…ƒæ•¸æ“š**

| Offset | Type | Name | èªªæ˜ | ç¯„ä¾‹å€¼ |
|--------|------|------|------|--------|
| 0 | char[4] | magic | å›ºå®šæ¨™è­˜ | `"PXLD"` |
| 4 | u8 | major_version | ä¸»ç‰ˆæœ¬è™Ÿ | `3` |
| 5 | u8 | minor_version | æ¬¡ç‰ˆæœ¬è™Ÿ | `0` |
| 6 | u8 | fps | æ¯ç§’å¹€æ•¸ | `40` |
| 7 | u16 | total_slaves | Slave ç¸½æ•¸ (æ”¯æ´ >255) | `33` |
| 9 | u32 | total_frames | æª”æ¡ˆç¸½å¹€æ•¸ | `12000` |
| 13 | u32 | total_channels | ç¸½é€šé“æ•¸ | `32620` |
| 17 | u32 | total_pixels | ç¸½ LED æ•¸ | `10873` |
| 21 | u16 | frame_header_size | æ¯ frame header å¤§å° | `32` |
| 23 | u16 | slave_entry_size | æ¯ slave entry å¤§å° | `24` |
| 25 | u16 | udp_port | UDP æ¨é€åŸ  | `4050` |
| 27 | u32 | file_crc32 | **æ•´å€‹æª”æ¡ˆçš„ CRC32** (offset 31 é–‹å§‹åˆ°æª”æ¡ˆçµå°¾) | |
| 31 | u8 | checksum_type | æ ¡é©—é¡å‹ (0=none, 1=CRC32) | `1` |
| 32 | u8[32] | reserved | é ç•™æ“´å±•å€ | |

### **æ ¡é©—é‚è¼¯**
```python
# è®€å– FileHeader
header = read_bytes(0, 64)

# æå–å®£å‘Šçš„ CRC32
declared_crc32 = struct.unpack('<I', header[27:31])[0]

# è¨ˆç®—å¯¦éš› CRC32 (å¾ offset 31 åˆ°æª”æ¡ˆçµå°¾)
file_data = read_bytes(31, file_size - 31)
calc_crc32 = binascii.crc32(file_data) & 0xFFFFFFFF

# é©—è­‰
assert declared_crc32 == calc_crc32, "FileHeader CRC32 æ ¡é©—å¤±æ•—!"
```

---

## **4. FrameHeader (32 bytes) - å¹€ç´šå…ƒæ•¸æ“š**

| Offset | Type | Name | èªªæ˜ |
|--------|------|------|------|
| 0 | u32 | frame_id | å¹€ç·¨è™Ÿ (0-based) |
| 4 | u32 | timestamp_ms | æ™‚é–“æˆ³è¨˜ (ms) |
| 8 | u16 | slave_count | æœ¬å¹€åŒ…å«çš„ slave æ•¸é‡ |
| 10 | u16 | flags | bit0=é—œéµå¹€, bit1=å£“ç¸® (é ç•™) |
| 12 | u32 | slave_table_size | SlaveTable ç¸½å¤§å° (bytes) |
| 16 | u32 | pixel_data_size | PixelData ç¸½å¤§å° (bytes) |
| 20 | u32 | ~~crc32~~ | **å·²ç§»é™¤** (æœ¬åœ°æª”æ¡ˆä¸éœ€è¦) |
| 20 | u8[12] | reserved | é ç•™å€ |

---

## **5. SlaveEntry (24 bytes) - Slave é…ç½®**

| Offset | Type | Name | èªªæ˜ | ç¯„ä¾‹ |
|--------|------|------|------|---------|
| 0 | u8 | slave_id | Slave ç·¨è™Ÿ | `0` |
| 1 | u8 | status | ç‹€æ…‹ (0=active, 1=sleep) | `0` |
| 2 | u16 | channel_start | èµ·å§‹é€šé“è™Ÿ (1-indexed) | `8379` |
| 4 | u16 | channel_count | æœ¬ slave é€šé“æ•¸ | `300` (fog) |
| 6 | u16 | pixel_count | æœ¬ slave ç¸½ LED æ•¸ | `130` |
| 8 | u16 | pixel_APA102C_count | APA102C æ•¸é‡ | `290` |
| 10 | u16 | pixel_WS2812B_count | WS2812B æ•¸é‡ | `30` |
| 12 | u16 | pixel_LED_count | STANDARD_LED æ•¸é‡ | `16` |
| 14 | u32 | data_offset | è³‡æ–™åœ¨ PixelData ä¸­çš„åç§» | `570`|
| 18 | u32 | data_length | è³‡æ–™é•·åº¦ (bytes) | `300` |
| 22 | u16 | reserved | é ç•™ | |

---

## **6. PixelData å€ - åŸå§‹åƒç´ è³‡æ–™**

- æ ¼å¼: **é€£çºŒçš„ bytes æµ**
- æ¯å€‹ slave çš„è³‡æ–™é€šé `SlaveEntry.data_offset` å’Œ `data_length` å®šä½
- è§£ç¢¼å™¨æ ¹æ“š slave è‡ªå·±çš„ config (å¤–éƒ¨ JSON) è§£æ LED é¡å‹å’Œæ’åˆ—

### **æå–ç¯„ä¾‹**
```python
# è®€å– slave 0 çš„è³‡æ–™
slave_entry = slave_table[0]
offset = pixel_data_start + slave_entry['data_offset']
length = slave_entry['data_length']

slave_data = read_bytes(offset, length)
# å¯¦éš›è§£æç”± slave config æ±ºå®š (APA102C/WS2812B æ··åˆæ’åˆ—)
```

---

## **7. è§£ç¢¼å™¨å¯¦ç¾æµç¨‹**

```python
class PXLDv3Decoder:
    def __init__(self, filepath):
        self.f = open(filepath, 'rb')
        
        # 1. è®€å–ä¸¦é©—è­‰ FileHeader
        self.file_header = self._read_file_header()
        self._verify_file_crc32()
        
        # 2. è¨ˆç®— frame èµ·å§‹ä½ç½®è¡¨ (å¯é¸,ç”¨æ–¼éš¨æ©Ÿè¨ªå•)
        self.frame_offsets = self._build_frame_index()
    
    def _verify_file_crc32(self):
        """ä¸€æ¬¡æ€§é©—è­‰æ•´å€‹æª”æ¡ˆ"""
        declared = self.file_header['file_crc32']
        
        self.f.seek(31)
        file_data = self.f.read()
        calc = binascii.crc32(file_data) & 0xFFFFFFFF
        
        assert declared == calc, "æª”æ¡ˆ CRC32 æ ¡é©—å¤±æ•—!"
    
    def read_frame(self, frame_id):
        """è®€å–æŒ‡å®š frame"""
        # è·³è½‰åˆ° frame èµ·å§‹ä½ç½®
        offset = self.frame_offsets[frame_id]
        self.f.seek(offset)
        
        # è®€å– FrameHeader
        fh_size = self.file_header['frame_header_size']
        frame_header = self._parse_frame_header(self.f.read(fh_size))
        
        # è®€å– SlaveTable
        slave_table_size = frame_header['slave_table_size']
        slave_table = self._parse_slave_table(
            self.f.read(slave_table_size),
            frame_header['slave_count']
        )
        
        # è®€å– PixelData
        pixel_data = self.f.read(frame_header['pixel_data_size'])
        
        return {
            'header': frame_header,
            'slaves': slave_table,
            'pixel_data': pixel_data
        }
    
    def get_slave_data(self, frame_data, slave_id):
        """æå–ç‰¹å®š slave çš„åŸå§‹è³‡æ–™"""
        slave = next(s for s in frame_data['slaves'] 
                     if s['slave_id'] == slave_id)
        
        start = slave['data_offset']
        end = start + slave['data_length']
        return frame_data['pixel_data'][start:end]
```

---

## **8. èˆ‡å·¥ç¨‹å¸«çš„é—œéµæºé€šé»**

### **âœ… é›¶ç¡¬ç·¨ç¢¼åŸå‰‡**
```python
# âŒ éŒ¯èª¤åšæ³• (ç¡¬ç·¨ç¢¼)
FRAME_SIZE = 32620
SLAVE_HEADER_SIZE = 396

# âœ… æ­£ç¢ºåšæ³• (è‡ªæè¿°)
frame_header_size = file_header['frame_header_size']
slave_table_size = frame_header['slave_table_size']
```

### **âœ… CRC32 ç­–ç•¥**
- **FileHeader**: é©—è­‰ä¸€æ¬¡ (offset 27 å„²å­˜,è¦†è“‹ offset 31 åˆ°æª”æ¡ˆçµå°¾)
- **FrameHeader**: ç§»é™¤ CRC32 (æœ¬åœ°æª”æ¡ˆä¸éœ€è¦)

### **âœ… Slave é…ç½®å¤–éƒ¨åŒ–**
- PXLD æª”æ¡ˆåªè¨˜éŒ„ `pixel_APA102C_count` / `pixel_WS2812B_count` / `pixel_LED_count`
- å…·é«” LED æ’åˆ—é †åºã€GPIO pinã€æ™‚åºåƒæ•¸ç”± **slave è‡ªå·±çš„ config.json** ç®¡ç†

### **âœ… éš¨æ©Ÿè¨ªå•æ”¯æ´**
```python
# å¿«é€Ÿè·³è½‰åˆ° frame 5000
decoder.read_frame(5000)  # ç„¡éœ€æƒæå‰ 4999 å€‹ frame
```

---

## **9. å®Œæ•´ Schema JSON**

```json
{
  "group": "pxld",
  "version": 3,
  "structures": [
    {
      "name": "FileHeader",
      "size": 64,
      "fields": [
        {"offset": 0,  "type": "char[4]", "name": "magic", "value": "PXLD"},
        {"offset": 4,  "type": "u8", "name": "major_version", "value": 3},
        {"offset": 5,  "type": "u8", "name": "minor_version", "value": 0},
        {"offset": 6,  "type": "u8", "name": "fps"},
        {"offset": 7,  "type": "u16", "name": "total_slaves"},
        {"offset": 9,  "type": "u32", "name": "total_frames"},
        {"offset": 13, "type": "u32", "name": "total_channels"},
        {"offset": 17, "type": "u32", "name": "total_pixels"},
        {"offset": 21, "type": "u16", "name": "frame_header_size"},
        {"offset": 23, "type": "u16", "name": "slave_entry_size"},
        {"offset": 25, "type": "u16", "name": "udp_port"},
        {"offset": 27, "type": "u32", "name": "file_crc32"},
        {"offset": 31, "type": "u8", "name": "checksum_type"},
        {"offset": 32, "type": "u8[32]", "name": "reserved"}
      ]
    },
    {
      "name": "FrameHeader",
      "size": 32,
      "fields": [
        {"offset": 0,  "type": "u32", "name": "frame_id"},
        {"offset": 4,  "type": "u32", "name": "timestamp_ms"},
        {"offset": 8,  "type": "u16", "name": "slave_count"},
        {"offset": 10, "type": "u16", "name": "flags"},
        {"offset": 12, "type": "u32", "name": "slave_table_size"},
        {"offset": 16, "type": "u32", "name": "pixel_data_size"},
        {"offset": 20, "type": "u8[12]", "name": "reserved"}
      ]
    },
    {
      "name": "SlaveEntry",
      "size": 24,
      "fields": [
        {"offset": 0,  "type": "u8",  "name": "slave_id"},
        {"offset": 1,  "type": "u8",  "name": "status"},
        {"offset": 2,  "type": "u16", "name": "channel_start"},
        {"offset": 4,  "type": "u16", "name": "channel_count"},
        {"offset": 6,  "type": "u16", "name": "pixel_count"},
        {"offset": 8,  "type": "u16", "name": "pixel_APA102C_count"},
        {"offset": 10, "type": "u16", "name": "pixel_WS2812B_count"},
        {"offset": 12, "type": "u16", "name": "pixel_LED_count"},
        {"offset": 14, "type": "u32", "name": "data_offset"},
        {"offset": 18, "type": "u32", "name": "data_length"},
        {"offset": 22, "type": "u16", "name": "reserved"}
      ]
    }
  ]
}
```

---

## **10. æª”æ¡ˆå¤§å°ä¼°ç®— (ä»¥ä½ çš„å°ˆæ¡ˆç‚ºä¾‹)**

```
FileHeader:        64 bytes
Frame Ã— 12000:
  FrameHeader:     32 Ã— 12000 = 384 KB
  SlaveTable:      24 Ã— 33 Ã— 12000 = 9.5 MB
  PixelData:       ~976 Ã— 33 Ã— 12000 = 387 MB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¸½è¨ˆ:              ~397 MB
```

---

**é€™ä»½æ–‡ä»¶å¯ä»¥ç›´æ¥äº¤çµ¦å·¥ç¨‹å¸«å¯¦ç¾!** ğŸš€ éœ€è¦æˆ‘è£œå……ä»»ä½•éƒ¨åˆ†å—?